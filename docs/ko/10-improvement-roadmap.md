# 개선 우선순위 및 로드맵 (성능/비용 중심)

본 로드맵은 **성능/비용** 관점을 최우선으로 두고,
현재 구조에서 영향도가 큰 항목부터 단계적으로 개선하는 방향을 제시합니다.

## 목표

- 평균 응답 시간 및 tail latency 감소
- 서버리스 비용(브라우저 런치/트래픽) 감소
- 병목 지점 식별을 위한 최소 관측 지표 확보

## 성공 기준 (현실적 목표)

- p50 응답시간 50% 개선
- p95 응답시간 50% 개선
- 요청당 브라우저 런치 수 50% 감소
- 캐시 히트율 30% 이상 달성

## 단계별 로드맵

### 1단계: 관측 지표 확보 (가장 낮은 리스크)

- static fetch 시간, dynamic launch 시간, navigation 시간, extraction 시간을 분리 측정
- 응답에 optional debug 필드로 포함하거나 로그로 출력
  
체크리스트:
- 단계별 타이머 유틸 추가 (static, dynamic, extract)
- crawl 결과에 단계별 ms 포함 여부 옵션화
- 로그 포맷 통일 (키 이름 표준화)
- 로그 샘플링 기준 수립 (환경 변수 기반)

기대 효과:
- 병목 지점을 빠르게 확인하고 이후 개선의 우선순위를 정량화할 수 있음

성공 기준:
- p50/p95 측정이 가능하고 단계별 시간 로그가 남음
- 성공/실패 모두 동일 포맷으로 로그가 남음

### 2단계: Static 비용 절감

- HTML 전체 다운로드 대신 head-only/early cutoff 파싱으로 전환
- 큰 페이지에서 다운로드/파싱 비용을 줄여 평균/최악 지연을 감소
  
체크리스트:
- HTTP 응답 스트리밍으로 head 추출 (용량 상한 설정)
- head 파싱 실패 시 full body fallback
- head-only 성공/실패를 로그로 확인 가능하게 메타 추가
- 최대 바이트/타임아웃 정책을 환경 변수로 분리
- OG 누락률 샘플링 측정

기대 효과:
- Static 경로의 체감 성능 개선, Auto 모드에서의 선행 지연 감소

성공 기준:
- p50 응답시간 개선 추세 확인

### 3단계: Auto 모드 전략 개선

- static과 dynamic을 병렬 또는 레이스 전략으로 구성
- 일정 시간 이후 dynamic을 병행하거나, static이 먼저 끝나면 즉시 반환
  
체크리스트:
- race 정책 정의 (예: static 300~500ms 후 dynamic 시작)
- 결과 스코어 기준 재검토 (score threshold)
- 타임아웃/취소 처리(AbortController) 정리
- 지연 임계치 환경 변수화 (예: `AUTO_DYNAMIC_DELAY_MS`)

기대 효과:
- static이 느린 URL에서도 전체 응답 지연을 줄임

성공 기준:
- p95 응답시간 개선 추세 확인

### 4단계: Dynamic 비용 절감

- 브라우저 재사용(풀링/웜 인스턴스) 전략 도입
- `networkidle` 대기를 제거하거나 더 짧은 조건으로 제한
  
체크리스트:
- 브라우저 재사용 정책 결정 (TTL/요청 수 기준, 환경 변수화)
- 풀링이 불가한 환경 대비 fallback 경로 (`DYNAMIC_BROWSER_REUSE` 제어)
- `networkidle` 대기 축소/비활성화 옵션 추가
- 런치 재사용 여부 로그로 측정 가능하게 메타 추가

기대 효과:
- 요청당 브라우저 런치 비용과 tail latency 감소

성공 기준:
- 요청당 브라우저 런치 수 감소 확인

### 5단계: 캐시 도입

- URL 기반 TTL 캐시로 동일 요청 반복 비용 제거
- 캐시 히트율을 통해 비용/성능 개선을 추가 측정
  
체크리스트:
- 캐시 키 정규화(redirect/utm 등)
- TTL 및 최대 크기 정책 수립 (`CACHE_TTL_MS`, `CACHE_MAX_SIZE`)
- 캐시 on/off 정책 (`CACHE_ENABLED`)
- 캐시 히트/미스 지표 기록 (`cache_hit`)

기대 효과:
- 반복 트래픽에서 비용과 지연이 크게 감소

성공 기준:
- 캐시 히트율 30% 이상

## 리스크 및 주의사항

- 브라우저 재사용은 서버리스 환경에서 제약이 있을 수 있음
- head-only 파싱은 일부 사이트에서 OG가 body에 있는 경우 누락 가능
- 캐시는 데이터 신선도와 트레이드오프가 있으므로 TTL 설정 필요
